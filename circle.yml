# https://circleci.com/docs/configuration#machine
machine:
  php:
    # https://circleci.com/docs/environment#php
    version: 7.0.7
  environment:
    TERMINUS_ENV: ci-$CIRCLE_BUILD_NUM
    TERMINUS_SITE: d8lcache
    DRUPAL_ADMIN_USERNAME: pantheon
    # A random password is set in the dependencies:pre stage as a text file.
    # This line reads the same file repeatedly. If the openssl call were used
    # in this step, it would result in a different password being used in each
    # line of other steps. Each CircleCI command runs in a separate shell.
    DRUPAL_ADMIN_PASSWORD: $(cat ~/DRUPAL_ADMIN_PASSWORD)

dependencies:
  cache_directories:
    - ~/.composer/cache
  pre:
    - echo $(openssl rand -hex 8) > ~/DRUPAL_ADMIN_PASSWORD
    # Set the PHP timezone so that Behat script does not fail.
    # Using > instead of >> will overwrite the file and disable xdebug.
    # xdebug makes composer slower.
    - echo "date.timezone = 'US/Central'"  >  /opt/circleci/php/7.0.7/etc/conf.d/xdebug.ini
    - git config --global user.email "noreply@pantheon.io"
    - git config --global user.name "Circle CI"
  override:
    - composer global require "hirak/prestissimo:^0.3"
    - composer global require pantheon-systems/terminus
    - composer global require drush/drush:8.*
    - composer install
  post:
    - terminus auth login --machine-token=$TERMINUS_TOKEN
test:
  pre:
    #- ./vendor/bin/phpcs --report=full --extensions=php,module,inc,theme,info,install --standard=vendor/drupal/coder/coder_sniffer/Drupal . --ignore=vendor,modules,core,drush,patches,tests
    # Make a new multidev env from a vanilla D8 site.
    - cd tests/circle-scripts && ./create-fresh-d8-site.sh
    - cd tests/circle-scripts && ./clone-repo.sh
    - cd tests/circle-scripts && ./core-vs-lcache.sh
  #
  #   - cd tests/circle-scripts && ./enable-modules.sh
  # override:
  #   - cd tests/circle-scripts && ./run-tests.sh
